<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Export User Data CSV</title>
</head>
<body>
  <script>
    // Paste your entire StorageManager class here
    class StorageManager {
      constructor() {
          this.storage = localStorage;
          this.USER_STREAKS_KEY = 'userStreaks';
          this.HIGH_STREAKS_KEY = 'highStreaks';
      }

      getAllUsers() {
          try {
              const users = this.storage.getItem(this.USER_STREAKS_KEY);
              return users ? JSON.parse(users) : [];
          } catch (error) {
              console.error("Error reading from localStorage:", error);
              return [];
          }
      }

      exportUserScoresToCSV() {
          try {
              const users = this.getAllUsers();

              if (users.length === 0) {
                  console.log("No user data to export");
                  alert("No user data to export.");
                  return;
              }

              const sortedUsers = [...users].sort((a, b) => b.highStreak - a.highStreak);

              const headers = ['Nickname', 'Email', 'High Streak', 'Consent', 'Last Updated'];

              const csvRows = sortedUsers.map(user => [
                  user.nickname,
                  user.email,
                  user.highStreak,
                  user.consent ? 'Yes' : 'No',
                  user.timestamp
              ]);

              const csvContent = [
                  headers.join(','),
                  ...csvRows.map(row => row.join(','))
              ].join('\n');

              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);

              link.setAttribute('href', url);
              link.setAttribute('download', `user_scores_${new Date().toISOString().split('T')[0]}.csv`);
              link.style.display = 'none';

              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              console.log("Successfully exported user scores to CSV");
              alert("CSV exported! Check your downloads.");

          } catch (error) {
              console.error("Error exporting user scores to CSV:", error);
              alert("Error exporting CSV. See console.");
          }
      }
    }

    // Run export immediately
    const storageManager = new StorageManager();
    storageManager.exportUserScoresToCSV();

    // Optional: close tab after a few seconds
    setTimeout(() => window.close(), 3000);
  </script>
</body>
</html>
